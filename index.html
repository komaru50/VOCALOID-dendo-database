<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ボカロ殿堂入りデータベース</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
body{font-family:'Noto Sans JP',sans-serif;background:#f5fbff;color:#222;margin:0;}
body.dark{background:#121212;color:#eee;}
header{background:#00bfff;color:white;padding:2rem;text-align:center;position:relative;}
h1{margin:0;font-size:2.3rem;}
nav{background:#008fd5;padding:1rem;text-align:center;}
nav a{color:white;margin:0 1rem;padding:.6rem 1.2rem;border-radius:8px;text-decoration:none;font-weight:bold;}
nav a.active,nav a:hover{background:#0066aa;}
.search-box{text-align:center;margin:2rem 0;}
.search-box input{padding:1rem 1.5rem;font-size:1.2rem;width:500px;max-width:90%;border-radius:50px;border:3px solid #00bfff;outline:none;}
table{width:100%;border-collapse:collapse;background:white;border-radius:15px;overflow:hidden;box-shadow:0 8px 30px rgba(0,191,255,.2);margin-bottom:2rem;}
body.dark table{background:#1e1e1e;}
th{background:#00bfff;color:white;padding:1.2rem;}
td{padding:1rem;border-bottom:1px solid #ddd;}
tr:hover{background:#f0fbff;}
body.dark tr:hover{background:#2a2a2a;}
a{color:#00bfff;text-decoration:none;font-weight:600;}
.tag{display:inline-block;background:#00aaff;color:white;padding:.4rem .9rem;border-radius:30px;margin:0.3rem;font-size:0.9rem;cursor:pointer;transition:0.3s;}
.tag:hover{background:#0088cc;transform:scale(1.1);}
.last-update{position:absolute;top:70px;right:20px;color:rgba(255,255,255,.9);font-size:0.9rem;}
#darkmode{position:absolute;top:20px;left:20px;background:#333;color:white;padding:.8rem 1.2rem;border-radius:50%;cursor:pointer;font-size:0.9rem;}
.fav{cursor:pointer;font-size:1.5rem;margin-right:8px;transition:.3s;}
.fav.on{color:#ff4444;transform:scale(1.2);}
.loading{text-align:center;padding:4rem;font-size:1.6rem;color:#0066aa;}
.pagination{text-align:center;margin:2rem 0;}
.pagination button{padding:.7rem 1.3rem;margin:0 .3rem;border:none;border-radius:8px;background:#00bfff;color:white;cursor:pointer;}
.pagination button.active{background:#0066aa;}
.song-page{max-width:900px;margin:3rem auto;background:white;padding:3rem;border-radius:20px;box-shadow:0 15px 40px rgba(0,191,255,.3);}
body.dark .song-page{background:#1e1e1e;}
.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:15px;margin:2rem 0;box-shadow:0 10px 30px rgba(0,0,0,.3);}
.embed-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none;}
.info-table{width:100%;margin-top:1rem;}
.info-table td:first-child{font-weight:bold;color:#00bfff;width:140px;}
.p-ranking td:nth-child(2){text-align:right;font-weight:bold;}
.deleted-notice{color:#c33;font-weight:bold;text-align:center;margin:2rem 0;}
</style>
</head>
<body>

<header>
<h1>ボカロ殿堂入りデータベース</h1>
<div class="last-update" id="last-update">読み込み中…</div>
<div id="darkmode">Night</div>
</header>

<nav>
<a href="#home" class="active">ランキング</a>
<a href="#list">全曲一覧</a>
<a href="#uploader">P別ランキング</a>
<a href="#fav">お気に入り</a>
<a href="#deleted">転載・削除曲</a>
<a href="#hitokoto">掲示板</a>
</nav>

<div class="search-box">
<input type="text" id="search" placeholder="曲名・投稿者・タグで検索">
</div>

<div class="container" id="main"></div>
<div class="pagination" id="pagination"></div>

<script>
const SPREADSHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbz9aQQ72C-a2jH6Do9_bZ1CUPuUkI92x_ZDKMA9fYDh85VaSPlT_DMY7Tr6cabtNcUr/exec";
let allData = [], deletedData = [], currentTag = "", currentPage = 1;
const PAGE_SIZE = 30;

async function loadData() {
  document.getElementById("main").innerHTML = "<div class='loading'>データ読み込み中…</div>";
  try {
    // メインと削除曲を並列で取得
    const [mainRes, deletedRes] = await Promise.all([
      fetch(SPREADSHEET_JSON_URL + "?t=" + Date.now()),
      fetch(SPREADSHEET_JSON_URL + "?type=deleted&t=" + Date.now()).catch(() => [])
    ]);

    allData = await mainRes.json();

    // 削除曲が取得できなかった場合は空配列（エラー回避）
    if (deletedRes.ok) {
      deletedData = await deletedRes.json();
    } else {
      deletedData = [];
    }

    document.getElementById("last-update").textContent = `最終更新：${new Date().toLocaleString("ja-JP")}`;
    render();
  } catch(e) {
    document.getElementById("main").innerHTML = "<div class='loading' style='color:#c33;'>読み込み失敗…リロードしてください</div>";
  }
}

function render() {
  const hash = location.hash.slice(1) || "home";
  const songId = hash.startsWith("song/") ? hash.slice(5) : null;

  // ナビアクティブ処理
  document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
  if (songId) {
    document.querySelector(`nav a[href="#home"]`).classList.add("active");
  } else {
    document.querySelector(`nav a[href="#${hash}"]`)?.classList.add("active");
  }

  // 楽曲個別ページはそのまま
  if (songId) {
    const song = allData.find(s => s.sm === songId);
    if (!song) {
      document.getElementById("main").innerHTML = "<div class='loading'>楽曲が見つかりません…</div>";
      return;
    }
    document.title = `${song.title} - ボカロ殿堂入りDB`;
    document.getElementById("main").innerHTML = `
      <div class="song-page">
        <h2>${song.title}</h2>
        <div class="embed-container">
          <iframe src="https://ext.nicovideo.jp/thumb_watch/${song.sm}?thumb_mode=html" allowfullscreen></iframe>
        </div>
        <table class="info-table">
          <tr><td>投稿日</td><td>${song.date || "不明"}</td></tr>
          <tr><td>投稿者</td><td>${song.uploader}</td></tr>
          <tr><td>再生数</td><td>${Number(song.view).toLocaleString()} 回</td></tr>
          <tr><td>殿堂入り達成日</td><td>${song.hallDate || "未設定"}</td></tr>
        </table>
        <div style="margin-top:2rem;">
          ${(song.tags||[]).map(t => `<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}
        </div>
        <div style="text-align:center;margin-top:3rem;">
          <a href="#home" style="color:#00bfff;font-size:1.2rem;">← ランキングに戻る</a>
        </div>
      </div>`;
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  // 転載・削除曲ページ
  if (hash === "deleted") {
    if (deletedData.length === 0) {
      document.getElementById("main").innerHTML = `<div class="deleted-notice">削除曲がまだ登録されていません</div>`;
      document.getElementById("pagination").innerHTML = "";
      document.title = "転載・削除曲 - ボカロ殿堂入りDB";
      return;
    }

    let filtered = deletedData.filter(v => {
      const q = (document.getElementById("search").value||"").toLowerCase();
      return !q || v.title.toLowerCase().includes(q) || v.uploader.toLowerCase().includes(q) || (v.tags||[]).some(t=>t.toLowerCase().includes(q));
    });

    const total = filtered.length;
    const pages = Math.ceil(total / PAGE_SIZE);
    currentPage = Math.min(currentPage, pages || 1);
    const start = (currentPage-1) * PAGE_SIZE;
    const pageData = filtered.slice(start, start + PAGE_SIZE);

    let html = `<div class="deleted-notice">転載・削除された殿堂入り曲（最終記録）</div>`;
    html += `<div style="text-align:center;margin:1rem;color:#555;">全 ${total} 曲中 ${start+1}〜${Math.min(start+PAGE_SIZE, total)} 件</div>`;
    html += `<table><thead><tr><th>#</th><th>曲名</th><th>投稿者</th><th>最終再生数</th><th>タグ</th></tr></thead><tbody>`;
    pageData.forEach((v, i) => {
      const rank = start + i + 1;
      html += `<tr>
        <td style="text-align:center;font-weight:bold;color:#c33;">${rank}</td>
        <td>${v.title} <span style="color:#aaa;font-size:0.9em;">(削除/転載済)</span></td>
        <td><a href="#tag/${encodeURIComponent(v.uploader)}">${v.uploader}</a></td>
        <td style="text-align:right;color:#c33;">${Number(v.view).toLocaleString()}</td>
        <td>${(v.tags||[]).map(t=>`<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}</td>
      </tr>`;
    });
    html += `</tbody></table>`;

    let pagi = "";
    for (let i=1; i<=pages; i++) {
      pagi += `<button ${i===currentPage?"class='active'":""} onclick="currentPage=${i};render()">${i}</button>`;
    }
    document.getElementById("pagination").innerHTML = pagi;
    document.getElementById("main").innerHTML = html;
    document.title = "転載・削除曲 - ボカロ殿堂入りDB";
    return;
  }

  // 以下、ランキング・全曲一覧・P別・お気に入り・タグ別 → 全部完全に元の挙動そのまま

  if (hash.startsWith("tag/")) {
    currentTag = decodeURIComponent(hash.slice(4));
    document.title = `${currentTag} - ボカロ殿堂入りDB`;
  } else {
    currentTag = "";
  }

  let filtered = allData.filter(v => {
    if (currentTag) return v.tags?.includes(currentTag);
    const q = (document.getElementById("search").value||"").toLowerCase();
    return !q || v.title.toLowerCase().includes(q) || v.uploader.toLowerCase().includes(q) || (v.tags||[]).some(t=>t.toLowerCase().includes(q));
  });

  if (hash === "fav") {
    const favs = Object.keys(localStorage).filter(k => k.startsWith("fav_")).map(k => k.slice(4));
    filtered = filtered.filter(v => favs.includes(v.sm));
  }

  if (hash === "uploader") {
    const uploaderCount = {};
    allData.forEach(v => {
      uploaderCount[v.uploader] = (uploaderCount[v.uploader] || 0) + 1;
    });
    const sorted = Object.entries(uploaderCount).sort((a,b) => b[1] - a[1]);
    let html = `<h2 style="text-align:center;color:#00bfff;margin:2rem;">P別殿堂入り数ランキング</h2>
    <table class="p-ranking"><thead><tr><th>順位</th><th>P名</th><th>殿堂入り曲数</th></tr></thead><tbody>`;
    sorted.forEach(([name, count], i) => {
      html += `<tr><td>${i+1}位</td><td><a href="#tag/${encodeURIComponent(name)}">${name}</a></td><td style="text-align:right;font-size:1.3rem;">${count}曲</td></tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById("main").innerHTML = html;
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  // ランキング順（#home と #list は同じ）
  if (hash === "home" || hash === "list" || hash === "") {
    filtered.sort((a,b) => b.view - a.view);
  }

  const total = filtered.length;
  const pages = Math.ceil(total / PAGE_SIZE);
  currentPage = Math.min(currentPage, pages || 1);
  const start = (currentPage-1) * PAGE_SIZE;
  const pageData = filtered.slice(start, start + PAGE_SIZE);

  let html = `<div style="text-align:center;margin:1rem;color:#555;">全 ${total} 曲中 ${start+1}〜${Math.min(start+PAGE_SIZE, total)} 件${currentTag?`（タグ: ${currentTag}）`:""}</div>`;
  html += `<table><thead><tr><th>#</th><th>曲名</th><th>投稿者</th><th>再生数</th><th>タグ</th></tr></thead><tbody>`;
  pageData.forEach((v, i) => {
    const rank = (hash === "home" || hash === "" || hash === "list") ? filtered.indexOf(v) + 1 : start + i + 1;
    const isFav = localStorage.getItem("fav_" + v.sm);
    html += `<tr>
      <td style="text-align:center;font-weight:bold;color:#00bfff;">${rank}</td>
      <td><span class="fav ${isFav?'on':''}" onclick="toggleFav('${v.sm}')">★</span>
          <a href="#song/${v.sm}">${v.title}</a></td>
      <td><a href="#tag/${encodeURIComponent(v.uploader)}">${v.uploader}</a></td>
      <td style="text-align:right;">${Number(v.view).toLocaleString()}</td>
      <td>${(v.tags||[]).map(t=>`<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}</td>
    </tr>`;
  });
  html += `</tbody></table>`;

  let pagi = "";
  for (let i=1; i<=pages; i++) {
    pagi += `<button ${i===currentPage?"class='active'":""} onclick="currentPage=${i};render()">${i}</button>`;
  }
  document.getElementById("pagination").innerHTML = pagi;
  document.getElementById("main").innerHTML = html;
}

function toggleFav(sm) {
  const key = "fav_" + sm;
  if (localStorage.getItem(key)) localStorage.removeItem(key);
  else localStorage.setItem(key, "1");
  render();
}

document.getElementById("darkmode").onclick = () => document.body.classList.toggle("dark");
document.getElementById("search").oninput = () => { currentPage=1; render(); };
window.onhashchange = () => { currentPage=1; render(); };
window.onload = loadData;
</script>
</body>
</html>
