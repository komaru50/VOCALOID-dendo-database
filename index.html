<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB</title>
<style>
body {
  font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 0;
}
header {
  background: #00bfff;
  color: white;
  padding: 1rem;
  text-align: center;
  font-size: 1.5rem;
  font-weight: bold;
}
nav {
  display: flex;
  justify-content: center;
  gap: 1rem;
  background: #eaf6ff;
  padding: 0.5rem;
}
nav a {
  color: #0077aa;
  text-decoration: none;
  font-weight: bold;
}
nav a:hover {
  text-decoration: underline;
}
#main {
  padding: 1rem;
  max-width: 1200px;
  margin: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 0.5rem;
}
th {
  background: #f0f8ff;
}
.tag {
  display: inline-block;
  background: #e0f4ff;
  color: #0077aa;
  padding: 2px 6px;
  margin: 2px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85rem;
}
.section {
  margin-bottom: 2.5rem;
}
.section h2 {
  color: #00bfff;
  text-align: center;
}
.random-box {
  background: white;
  border: 2px dashed #00bfff;
  padding: 1rem;
  text-align: center;
  border-radius: 8px;
}
.random-box h3 {
  margin: 0.5rem 0;
}
.anniv-table td {
  font-size: 0.95rem;
}
</style>
</head>

<body>
<header>ğŸ§ ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB</header>

<nav>
  <a href="#home">HOME</a>
  <a href="#ranking">RANKING</a>
  <a href="#list">LIST</a>
</nav>

<div id="main">èª­ã¿è¾¼ã¿ä¸­...</div>

<script>
const API_URL = "ï¼ˆã‚ãªãŸã®AppsScriptã®URLï¼‰";

let allData = [];

function seededRandom(seed) {
  let x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

async function loadData() {
  const res = await fetch(API_URL);
  allData = await res.json();
  render();
}

function render() {
  const hash = location.hash.replace("#", "") || "home";

  if (hash === "home") {
    renderHome();
    return;
  }
}

function renderHome() {
  const today = new Date();
  const month = today.getMonth() + 1;
  const day = today.getDate();

  /* =====================
     ğŸ² ä»Šæ—¥ã®1æ›²ï¼ˆå›ºå®šãƒ©ãƒ³ãƒ€ãƒ ï¼‰
     ===================== */
  const seed = Number(
    today.getFullYear().toString() +
    ("0" + month).slice(-2) +
    ("0" + day).slice(-2)
  );

  const randomIndex = Math.floor(seededRandom(seed) * allData.length);
  const randomSong = allData[randomIndex];

  let html = `<div class="section">
    <h2>ğŸ² ä»Šæ—¥ã®1æ›²</h2>
    <div class="random-box">
      <h3><a href="#song/${randomSong.sm}">${randomSong.title}</a></h3>
      <div>æŠ•ç¨¿è€…ï¼š${randomSong.uploader}</div>
      <div>å†ç”Ÿæ•°ï¼š${randomSong.view.toLocaleString()} å›</div>
      <div style="margin-top:0.5rem;">
        ${(randomSong.tags || []).map(t =>
          `<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`
        ).join(" ")}
      </div>
    </div>
  </div>`;

  /* =====================
     ğŸ‰ ä»Šæ—¥ã®å‘¨å¹´æ›²
     ===================== */
  const anniversarySongs = allData.filter(song => {
    if (!song.date) return false;
    const d = new Date(song.date);
    if (isNaN(d.getTime())) return false;
    return (d.getMonth() + 1 === month && d.getDate() === day);
  });

  html += `<div class="section">
    <h2>ğŸ‰ ä»Šæ—¥ã®å‘¨å¹´æ›²</h2>`;

  if (anniversarySongs.length === 0) {
    html += `<div style="text-align:center;color:#666;">ä»Šæ—¥ã¯å‘¨å¹´æ›²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
  } else {
    html += `<table class="anniv-table">
      <thead>
        <tr>
          <th>#</th>
          <th>æ›²å</th>
          <th>æŠ•ç¨¿è€…</th>
          <th>å†ç”Ÿæ•°</th>
          <th>æŠ•ç¨¿å¹´</th>
        </tr>
      </thead>
      <tbody>`;

    anniversarySongs.forEach((song, i) => {
      let postYear = "ä¸æ˜";
      const d = new Date(song.date);
      if (!isNaN(d.getTime())) {
        postYear = d.getFullYear() + "å¹´";
      }

      html += `<tr>
        <td style="text-align:center;">${i + 1}</td>
        <td><a href="#song/${song.sm}">${song.title}</a></td>
        <td>${song.uploader}</td>
        <td style="text-align:right;">${song.view.toLocaleString()}</td>
        <td style="text-align:center;">${postYear}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
  }

  html += `</div>`;

  document.getElementById("main").innerHTML = html;
}

window.onhashchange = render;
window.onload = loadData;
</script>
</body>
</html>
