<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
body{font-family:'Noto Sans JP',sans-serif;background:#f5fbff;color:#222;margin:0;}
body.dark{background:#121212;color:#eee;}
header{background:#00bfff;color:white;padding:2rem;text-align:center;position:relative;}
h1{margin:0;font-size:2.3rem;}
nav{background:#008fd5;padding:1rem;text-align:center;display:flex;flex-wrap:wrap;justify-content:center;gap:0.5rem;}
nav a{color:white;padding:0.6rem 1rem;border-radius:8px;text-decoration:none;font-weight:bold;font-size:1rem;transition:0.3s;}
nav a.active,nav a:hover{background:#0066aa;}
.search-box{text-align:center;margin:2rem 0;}
.search-box input{padding:1rem 1.5rem;font-size:1.2rem;width:500px;max-width:90%;border-radius:50px;border:3px solid #00bfff;outline:none;}
table{width:100%;border-collapse:collapse;background:white;border-radius:15px;overflow:hidden;box-shadow:0 8px 30px rgba(0,191,255,.2);margin-bottom:2rem;}
body.dark table{background:#1e1e1e;}
th{background:#00bfff;color:white;padding:1.2rem;}
td{padding:1rem;border-bottom:1px solid #ddd;}
tr:hover{background:#f0fbff;}
body.dark tr:hover{background:#2a2a2a;}
a{color:#00bfff;text-decoration:none;font-weight:600;}
.tag{display:inline-block;background:#00aaff;color:white;padding:.4rem .9rem;border-radius:30px;margin:0.3rem;font-size:0.9rem;cursor:pointer;transition:0.3s;}
.tag:hover{background:#0088cc;transform:scale(1.1);}
.last-update{position:absolute;top:70px;right:20px;color:rgba(255,255,255,.9);font-size:0.9rem;}
#darkmode{position:absolute;top:20px;left:20px;background:#333;color:white;padding:.8rem 1.2rem;border-radius:50%;cursor:pointer;font-size:0.9rem;}
.fav{cursor:pointer;font-size:1.5rem;margin-right:8px;transition:.3s;}
.fav.on{color:#ff4444;transform:scale(1.2);}
.loading{text-align:center;padding:4rem;font-size:1.6rem;color:#0066aa;}
.pagination{text-align:center;margin:2rem 0;}
.pagination button{padding:.7rem 1.3rem;margin:0 .3rem;border:none;border-radius:8px;background:#00bfff;color:white;cursor:pointer;}
.pagination button.active{background:#0066aa;}
.song-page{max-width:900px;margin:3rem auto;background:white;padding:3rem;border-radius:20px;box-shadow:0 15px 40px rgba(0,191,255,.3);}
body.dark .song-page{background:#1e1e1e;}
.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:15px;margin:2rem 0;box-shadow:0 10px 30px rgba(0,0,0,.3);}
.embed-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none;}
.info-table{width:100%;margin-top:1rem;}
.info-table td:first-child{font-weight:bold;color:#00bfff;width:140px;}
.deleted-notice{color:#c33;font-weight:bold;text-align:center;margin:2rem 0;}
.p-ranking td{text-align:left !important;}
.p-ranking td:nth-child(3){font-size:1.3rem;font-weight:bold;}
.home-section{margin:3rem auto;max-width:1000px;padding:0 1rem;}
.today-song{background:white;padding:2rem 2rem 2.5rem;border-radius:20px;box-shadow:0 10px 30px rgba(0,191,255,.3);margin-bottom:4rem;}
body.dark .today-song{background:#1e1e1e;}
.today-song h2{font-size:2rem;color:#00bfff;margin-bottom:1.5rem;text-align:left;}
.today-song h3{font-size:1.8rem;margin:1rem 0;text-align:left;}
.today-song p{margin:0.5rem 0;text-align:left;}
.anniversary-section h2{font-size:1.8rem;color:#00bfff;margin-bottom:1.5rem;text-align:left;}
</style>
</head>
<body>

<header>
<h1>ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
<div class="last-update" id="last-update">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
<div id="darkmode">Night</div>
</header>

<nav>
<a href="#home" class="active">ãƒ›ãƒ¼ãƒ </a>
<a href="#ranking">ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
<a href="#list">å…¨æ›²ä¸€è¦§</a>
<a href="#uploader">Påˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
<a href="#fav">ãŠæ°—ã«å…¥ã‚Š</a>
<a href="#deleted">è»¢è¼‰ãƒ»å‰Šé™¤æ›²</a>
<a href="#dendofastestranking">æ®¿å ‚å…¥ã‚Šæœ€é€Ÿãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
</nav>

<div class="search-box">
<input type="text" id="search" placeholder="æ›²åãƒ»æŠ•ç¨¿è€…ãƒ»ã‚¿ã‚°ã§æ¤œç´¢">
</div>

<div class="container" id="main"></div>
<div class="pagination" id="pagination"></div>

<script>
const SPREADSHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbzmy850fQI4QsOxV2XNuBKNB9H9-SZ_16MmcOISGTPtPYEGiRbAycp3WJ_uNg372H95/exec";
let allData = [], deletedData = [], currentTag = "", currentPage = 1;
const PAGE_SIZE = 30;

function toNumber(val) { return Number(val)||0; }

function formatHallDate(dateStr){
  if(!dateStr||dateStr==="æœªè¨­å®š") return "æœªè¨­å®š";
  if(/^\d{4}\/\d{2}\/\d{2}$/.test(dateStr)) return dateStr;
  const date=new Date(dateStr);
  if(!isNaN(date.getTime())){
    const y=date.getFullYear();
    const m=String(date.getMonth()+1).padStart(2,'0');
    const d=String(date.getDate()).padStart(2,'0');
    return `${y}/${m}/${d}`;
  }
  return dateStr;
}

function formatDateYMD(dateStr){
  if(!dateStr) return "ä¸æ˜";
  let s=String(dateStr).trim();
  s=s.replace(/^(\d{4}\/\d{2}\/\d{2}).*$/,"$1");
  s=s.replace(/-/g,"/");
  if(/^\d{4}\/\d{2}\/\d{2}$/.test(s)) return s;
  const d=new Date(dateStr);
  if(!isNaN(d.getTime())){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const day=String(d.getDate()).padStart(2,"0");
    return `${y}/${m}/${day}`;
  }
  return "ä¸æ˜";
}

async function loadData(){
  document.getElementById("main").innerHTML="<div class='loading'>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦</div>";
  try{
    const [mainRes, deletedRes] = await Promise.all([
      fetch(SPREADSHEET_JSON_URL+"?t="+Date.now()),
      fetch(SPREADSHEET_JSON_URL+"?type=deleted&t="+Date.now()).catch(()=>[])
    ]);

    allData=await mainRes.json();
    allData.forEach(song=>{
      song.view=toNumber(song.view);
      song.mylist=toNumber(song.mylist||0); // â˜…è¿½åŠ 
      song.daily_diff=toNumber(song.daily_diff||0);
      song.weekly_diff=toNumber(song.weekly_diff||0);
      song.monthly_diff=toNumber(song.monthly_diff||0);});


    if(deletedRes.ok){
      deletedData=await deletedRes.json();
      deletedData.forEach(song=>song.view=toNumber(song.view));
    }else deletedData=[];

    document.getElementById("last-update").textContent=`æœ€çµ‚æ›´æ–°ï¼š${new Date().toLocaleString("ja-JP")}`;
    render();
  }catch(e){
    console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",e);
    document.getElementById("main").innerHTML="<div class='loading' style='color:#c33;'>èª­ã¿è¾¼ã¿å¤±æ•—â€¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</div>";
  }
}

function render(){
  const hash = location.hash.slice(1) || "home";
  const songId = hash.startsWith("song/") ? hash.slice(5) : null;
  const tagName = hash.startsWith("tag/") ? decodeURIComponent(hash.slice(4)) : null;

  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  if(songId) document.querySelector(`nav a[href="#ranking"]`).classList.add("active");
  else document.querySelector(`nav a[href="#${hash}"]`)?.classList.add("active")||document.querySelector(`nav a[href="#home"]`).classList.add("active");

  // --- æ¥½æ›²ãƒšãƒ¼ã‚¸ ---
  if(songId){
    const song=allData.find(s=>s.sm===songId);
    if(!song){
      document.getElementById("main").innerHTML="<div class='loading'>æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“â€¦</div>";
      return;
    }
    document.title=`${song.title} - ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB`;
    const formattedHallDate=formatHallDate(song.hallDate||"æœªè¨­å®š");
    document.getElementById("main").innerHTML=`
      <div class="song-page">
        <h2>${song.title}</h2>
        <div class="embed-container">
          <iframe src="https://ext.nicovideo.jp/thumb_watch/${song.sm}?thumb_mode=html" allowfullscreen></iframe>
        </div>
        <table class="info-table">
          <tr><td>æŠ•ç¨¿æ—¥</td><td>${formatDateYMD(song.date)}</td></tr>
          <tr><td>æŠ•ç¨¿è€…</td><td>${song.uploader}</td></tr>
          <tr><td>å†ç”Ÿæ•°</td><td>${song.view.toLocaleString()} å›</td></tr>
          <tr><td>ãƒã‚¤ãƒªã‚¹ãƒˆæ•°</td><td>${(song.mylist ?? 0).toLocaleString()} </td></tr>
          <tr><td>æ®¿å ‚å…¥ã‚Šé”æˆæ—¥</td><td>${formattedHallDate}</td></tr>
        </table>
        <div style="margin-top:2rem;">
          ${(song.tags||[]).map(t=>`<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}
        </div>
        <div style="text-align:center;margin-top:3rem;">
          <a href="#ranking" style="color:#00bfff;font-size:1.2rem;">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</a>
        </div>
      </div>`;
    document.getElementById("pagination").innerHTML="";
    return;
  }

  // --- ãƒ›ãƒ¼ãƒ  ---
  if(hash==="home"||hash===""){
    const today=new Date();
    const todayMMDD=`${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    const seed=today.getFullYear()*10000+(today.getMonth()+1)*100+today.getDate();
    function seededRandom(seed){const x=Math.sin(seed)*10000;return x-Math.floor(x);}
    const randomIndex=Math.floor(seededRandom(seed)*allData.length);
    const randomSong=allData[randomIndex];

    const anniversarySongs=allData.filter(song=>{
      if(!song.date) return false;
      const dateStr=String(song.date).trim();
      const d=new Date(dateStr);
      if(isNaN(d.getTime())) return false;
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      return `${mm}-${dd}`===todayMMDD;
    }).sort((a,b)=>b.view-a.view);

    let html=`<div class="home-section">`;
    if(randomSong){
      html+=`
      <div class="today-song">
        <h2> ğŸ²ä»Šæ—¥ã®1æ›²</h2>
        <h3><a href="#song/${randomSong.sm}">${randomSong.title}</a></h3>
        <p>æŠ•ç¨¿è€…ï¼š<a href="#tag/${encodeURIComponent(randomSong.uploader)}">${randomSong.uploader}</a>ã€€å†ç”Ÿæ•°ï¼š${randomSong.view.toLocaleString()}å›</p>
        <div class="embed-container" style="max-width:800px;margin:1.5rem auto;">
          <iframe src="https://ext.nicovideo.jp/thumb_watch/${randomSong.sm}?thumb_mode=html" allowfullscreen></iframe>
        </div>
        <div>${(randomSong.tags||[]).map(t=>`<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}</div>
      </div>`;
    }

    html+=`<div class="anniversary-section"><h2> ğŸ‰ä»Šæ—¥ã®å‘¨å¹´æ›²ï¼ˆ${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ æŠ•ç¨¿ï¼‰</h2>`;
    if(anniversarySongs.length===0){
      html+=`<p style="text-align:center;color:#888;">ä»Šæ—¥ã¯å‘¨å¹´ã‚’è¿ãˆã‚‹æ®¿å ‚å…¥ã‚Šæ›²ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
    }else{
      html+=`<table><thead><tr><th>#</th><th>æ›²å</th><th>æŠ•ç¨¿è€…</th><th>å†ç”Ÿæ•°</th><th>æŠ•ç¨¿å¹´</th></tr></thead><tbody>`;
      anniversarySongs.forEach((song,i)=>{
        let postYear="ä¸æ˜";
        if(song.date && /^\d{4}\/\d{2}\/\d{2}$/.test(song.date)) postYear=song.date.slice(0,4)+"å¹´";
        html+=`<tr>
          <td style="text-align:center;font-weight:bold;color:#00bfff;">${i+1}</td>
          <td><a href="#song/${song.sm}">${song.title}</a></td>
          <td><a href="#tag/${encodeURIComponent(song.uploader)}">${song.uploader}</a></td>
          <td style="text-align:right;">${song.view.toLocaleString()}</td>
          <td style="text-align:center;">${postYear}</td>
        </tr>`;
      });
      html+=`</tbody></table>`;
    }
    html+=`</div></div>`;
    document.getElementById("main").innerHTML=html;
    document.getElementById("pagination").innerHTML="";
    return;
  }
 
// --- ã‚¿ã‚°åˆ¥ãƒšãƒ¼ã‚¸ ---
if(tagName){
  currentTag = tagName;
  document.title = `${tagName} - ã‚¿ã‚°åˆ¥è¡¨ç¤º | ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB`;

  let filtered = allData.filter(v =>
    v.uploader === tagName ||
    (v.tags || []).includes(tagName)
  );

  if(filtered.length === 0){
    document.getElementById("main").innerHTML =
      `<div class="loading">ã€Œ${tagName}ã€ã®æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>`;
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  filtered.sort((a,b)=>b.view-a.view);

  const total = filtered.length;
  const pages = Math.ceil(total / PAGE_SIZE);
  currentPage = Math.min(currentPage, pages || 1);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageData = filtered.slice(start, start + PAGE_SIZE);

  let html = `
    <h2 style="text-align:center;color:#00bfff;margin:2rem;">
      ğŸ· ã‚¿ã‚°ï¼š${tagName}
    </h2>
    <div style="text-align:center;margin:1rem;color:#555;">
      ${total} æ›²
    </div>
    <table>
      <thead>
        <tr><th>#</th><th>æ›²å</th><th>æŠ•ç¨¿è€…</th><th>å†ç”Ÿæ•°</th><th>ã‚¿ã‚°</th></tr>
      </thead>
      <tbody>
  `;

  pageData.forEach((v,i)=>{
    const rank = start + i + 1;
    html += `
      <tr>
        <td style="text-align:center;font-weight:bold;color:#00bfff;">${rank}</td>
        <td><a href="#song/${v.sm}">${v.title}</a></td>
        <td><a href="#tag/${encodeURIComponent(v.uploader)}">${v.uploader}</a></td>
        <td style="text-align:right;">${v.view.toLocaleString()}</td>
        <td>${(v.tags||[]).map(t=>`
          <span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>
        `).join(" ")}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  document.getElementById("main").innerHTML = html;

  let pagi = "";
  for(let i=1;i<=pages;i++){
    pagi += `<button ${i===currentPage?"class='active'":""}
      onclick="currentPage=${i};render()">${i}</button>`;
  }
  document.getElementById("pagination").innerHTML = pagi;
  return;
}
 
  // --- å‰Šé™¤æ›² ---
  if(hash==="deleted"){
    if(deletedData.length===0){
      document.getElementById("main").innerHTML=`<div class="deleted-notice">å‰Šé™¤æ›²ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
      document.getElementById("pagination").innerHTML="";
      document.title="è»¢è¼‰ãƒ»å‰Šé™¤æ›² - ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB";
      return;
    }
    let filtered=deletedData.filter(v=>{
      const q=(document.getElementById("search").value||"").toLowerCase();
      return !q||v.title.toLowerCase().includes(q)||v.uploader.toLowerCase().includes(q)||(v.tags||[]).some(t=>t.toLowerCase().includes(q));
    });
    const total=filtered.length;
    const pages=Math.ceil(total/PAGE_SIZE);
    currentPage=Math.min(currentPage,pages||1);
    const start=(currentPage-1)*PAGE_SIZE;
    const pageData=filtered.slice(start,start+PAGE_SIZE);

    let html=`<div class="deleted-notice">è»¢è¼‰ãƒ»å‰Šé™¤ã•ã‚ŒãŸæ®¿å ‚å…¥ã‚Šæ›²ï¼ˆæœ€çµ‚è¨˜éŒ²ï¼‰</div>`;
    html+=`<div style="text-align:center;margin:1rem;color:#555;">å…¨ ${total} æ›²ä¸­ ${start+1}ã€œ${Math.min(start+PAGE_SIZE,total)} ä»¶</div>`;
    html+=`<table><thead><tr><th>#</th><th>æ›²å</th><th>æŠ•ç¨¿è€…</th><th>æœ€çµ‚å†ç”Ÿæ•°</th><th>ã‚¿ã‚°</th></tr></thead><tbody>`;
    pageData.forEach((v,i)=>{
      const rank=start+i+1;
      html+=`<tr>
        <td style="text-align:center;font-weight:bold;color:#c33;">${rank}</td>
        <td>${v.title} <span style="color:#aaa;font-size:0.9em;">(å‰Šé™¤/è»¢è¼‰æ¸ˆ)</span></td>
        <td><a href="#tag/${encodeURIComponent(v.uploader)}">${v.uploader}</a></td>
        <td style="text-align:right;color:#c33;">${v.view.toLocaleString()}</td>
        <td>${(v.tags||[]).map(t=>`<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
    let pagi="";
    for(let i=1;i<=pages;i++) pagi+=`<button ${i===currentPage?"class='active'":""} onclick="currentPage=${i};render()">${i}</button>`;
    document.getElementById("pagination").innerHTML=pagi;
    document.getElementById("main").innerHTML=html;
    document.title="è»¢è¼‰ãƒ»å‰Šé™¤æ›² - ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB";
    return;
  }

  

  // --- ãã®ä»–ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° / å…¨æ›²ä¸€è¦§ / ãŠæ°—ã«å…¥ã‚Š / Påˆ¥ ---
  let filtered=allData.filter(v=>{
    const q=(document.getElementById("search").value||"").toLowerCase();
    return !q||v.title.toLowerCase().includes(q)||v.uploader.toLowerCase().includes(q)||(v.tags||[]).some(t=>t.toLowerCase().includes(q));
  });

  if(hash==="fav"){
    const favs=Object.keys(localStorage).filter(k=>k.startsWith("fav_")).map(k=>k.slice(4));
    filtered=filtered.filter(v=>favs.includes(v.sm));
  }

  if(hash==="uploader"){
    const uploaderCount={};
    allData.forEach(v=>uploaderCount[v.uploader]=(uploaderCount[v.uploader]||0)+1);
    const sorted=Object.entries(uploaderCount).sort((a,b)=>b[1]-a[1]);
    let html=`<h2 style="text-align:center;color:#00bfff;margin:2rem;">Påˆ¥æ®¿å ‚å…¥ã‚Šæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <table class="p-ranking"><thead><tr><th>é †ä½</th><th>På</th><th>æ®¿å ‚å…¥ã‚Šæ›²æ•°</th></tr></thead><tbody>`;
    sorted.forEach(([name,count],i)=>{
      html+=`<tr>
        <td>${i+1}ä½</td>
        <td><a href="#tag/${encodeURIComponent(name)}">${name}</a></td>
        <td>${count}æ›²</td>
      </tr>`;
    });
    html+=`</tbody></table>`;
    document.getElementById("main").innerHTML=html;
    document.getElementById("pagination").innerHTML="";
    document.title="Påˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚° - ãƒœã‚«ãƒ­æ®¿å ‚å…¥ã‚ŠDB";
    return;
  }

  // --- ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã© ---
  if(hash==="ranking") filtered.sort((a,b)=>b.view-a.view);
  else if(hash==="list") filtered.sort((a,b)=>a.uploader.localeCompare(b.uploader));

  const total=filtered.length;
  let pageData,pagi="";
  if(hash==="list"){pageData=filtered;currentPage=1;document.getElementById("pagination").innerHTML="";}
  else{
    const pages=Math.ceil(total/PAGE_SIZE);
    currentPage=Math.min(currentPage,pages||1);
    const start=(currentPage-1)*PAGE_SIZE;
    pageData=filtered.slice(start,start+PAGE_SIZE);
    for(let i=1;i<=pages;i++) pagi+=`<button ${i===currentPage?"class='active'":""} onclick="currentPage=${i};render()">${i}</button>`;
    document.getElementById("pagination").innerHTML=pagi;
  }

  let html=`<div style="text-align:center;margin:1rem;color:#555;">å…¨ ${total} æ›²ä¸­ ${currentTag?`ï¼ˆã‚¿ã‚°: ${currentTag}ï¼‰`:""}</div>`;
  html+=`<table><thead><tr><th>#</th><th>æ›²å</th><th>æŠ•ç¨¿è€…</th><th>å†ç”Ÿæ•°</th><th>ã‚¿ã‚°</th></tr></thead><tbody>`;
  pageData.forEach((v,i)=>{
    const rank=filtered.indexOf(v)+1;
    const isFav=localStorage.getItem("fav_"+v.sm);
    html+=`<tr>
      <td style="text-align:center;font-weight:bold;color:#00bfff;">${rank}</td>
      <td><span class="fav ${isFav?'on':''}" onclick="toggleFav('${v.sm}')">â˜…</span>
          <a href="#song/${v.sm}">${v.title}</a></td>
      <td><a href="#tag/${encodeURIComponent(v.uploader)}">${v.uploader}</a></td>
      <td style="text-align:right;">${v.view.toLocaleString()}</td>
      <td>${(v.tags||[]).map(t=>`<span class="tag" onclick="location.hash='#tag/${encodeURIComponent(t)}'">${t}</span>`).join(" ")}</td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById("main").innerHTML=html;
}

function toggleFav(sm){
  const key="fav_"+sm;
  if(localStorage.getItem(key)) localStorage.removeItem(key);
  else localStorage.setItem(key,"1");
  render();
}

document.getElementById("darkmode").onclick=()=>document.body.classList.toggle("dark");
document.getElementById("search").oninput=()=>{currentPage=1;render();};
window.onhashchange=()=>{currentPage=1;render();};
window.onload=loadData;
</script>

</body>
</html>
