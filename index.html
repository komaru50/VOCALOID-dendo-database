<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ボカロ殿堂入りデータベース - komaru50</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
body{font-family:'Noto Sans JP',sans-serif;background:#f0f8ff;color:#222;margin:0;transition:.3s;}
body.dark{background:#121212;color:#eee;}
header{background:#00bfff;color:white;padding:2rem;text-align:center;position:relative;box-shadow:0 8px 32px rgba(0,191,255,.4);}
h1{margin:0;font-size:2.5rem;}
nav{background:#008fd5;padding:1rem;text-align:center;}
nav a{color:white;margin:0 1rem;padding:.6rem 1.2rem;border-radius:8px;text-decoration:none;font-weight:bold;transition:.2s;}
nav a.active,nav a:hover{background:#0066aa;}
.container{max-width:1300px;margin:2rem auto;padding:0 1rem;}
.search-box{text-align:center;margin:2rem 0;}
.search-box input{padding:1rem 1.5rem;font-size:1.2rem;width:500px;max-width:90%;border-radius:50px;border:3px solid #00bfff;outline:none;}
table{width:100%;border-collapse:collapse;background:white;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,191,255,.3);margin-bottom:2rem;}
body.dark table{background:#1e1e1e;}
th{background:#00bfff;color:white;padding:1.2rem;}
td{padding:1rem;border-bottom:1px solid #eee;}
tr:hover{background:#f0fbff;}
body.dark tr:hover{background:#2a2a2a;}
a{color:#00bfff;text-decoration:none;font-weight:600;}
.tag{display:inline-block;background:#00bfff;color:white;padding:.4rem .9rem;border-radius:30px;margin:.3rem;font-size:.9rem;cursor:pointer;}
.tag:hover{background:#0099cc;}
.update-btn{position:absolute;top:20px;right:20px;background:#ff4444;color:white;border:none;padding:.8rem 1.5rem;border-radius:50px;font-weight:bold;cursor:pointer;}
.last-update{position:absolute;top:70px;right:20px;color:rgba(255,255,255,.9);font-size:.9rem;}
#darkmode{position:absolute;top:20px;left:20px;background:#333;color:white;padding:.8rem;border-radius:50%;cursor:pointer;font-size:1.2rem;}
.fav{cursor:pointer;font-size:1.4rem;margin-right:.5rem;}
.fav.on{color:#ff4444;}
.diff{font-weight:bold;margin-left:.5rem;}
.diff.up{color:#0a0;}
.diff.down{color:#d00;}
.loading{text-align:center;padding:5rem;font-size:1.6rem;color:#0066aa;font-weight:bold;}
.pagination{text-align:center;margin:3rem 0;}
.pagination button{padding:.8rem 1.5rem;margin:0 .3rem;border:none;border-radius:8px;background:#00bfff;color:white;font-weight:bold;cursor:pointer;}
.pagination button:disabled{background:#aaa;cursor:not-allowed;}
.pagination button.active{background:#0066aa;}
#hitokoto-section{background:white;border-radius:15px;padding:3rem;margin:3rem auto;max-width:900px;box-shadow:0 15px 40px rgba(0,191,255,.3);display:none;}
body.dark #hitokoto-section{background:#1e1e1e;}
.hitokoto-item{padding:1.2rem 0;border-bottom:1px dashed #bde0fe;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
.hitokoto-no{color:#00bfff;font-weight:bold;font-size:1.3rem;width:50px;text-align:center;}
.hitokoto-name{color:#00bfff;font-weight:bold;}
.hitokoto-comment{flex:1;font-size:1.1rem;}
.hitokoto-date{color:#888;font-size:0.9rem;}
</style>
</head>
<body>

<header>
  <h1>ボカロ殿堂入りデータベース</h1>
  <button class="update-btn" id="update">今日のデータ更新</button>
  <div class="last-update" id="last-update">読み込み中…</div>
  <div id="darkmode" title="ダークモード">Night</div>
</header>

<nav>
  <a href="#home" class="active">ランキング</a>
  <a href="#list">全曲一覧</a>
  <a href="#p">P別</a>
  <a href="#fav">お気に入り</a>
  <a href="#hitokoto">掲示板</a>
</nav>

<div class="search-box">
  <input type="text" id="search" placeholder="曲名・投稿者・タグで検索">
</div>

<div class="container" id="main"></div>
<div class="pagination" id="pagination"></div>

<div id="hitokoto-section">
  <h2 style="text-align:center;color:#00bfff;font-size:2.5rem;margin-bottom:1.5rem;">一言掲示板</h2>
  <div style="background:#f0fbff;padding:2rem;border-radius:12px;text-align:center;margin-bottom:2rem;">
    <input type="text" id="hitokoto-name" placeholder="名前（省略可）" maxlength="20" style="padding:.8rem;border-radius:50px;border:2px solid #00bfff;margin:0 .5rem;width:200px;">
    <input type="text" id="hitokoto-comment" placeholder="一言どうぞ！" maxlength="100" style="padding:.8rem;border-radius:50px;border:2px solid #00bfff;margin:0 .5rem;width:300px;">
    <button id="hitokoto-submit" style="padding:.8rem 2rem;background:#00bfff;color:white;border:none;border-radius:50px;font-weight:bold;">書き込む</button>
  </div>
  <div id="hitokoto-list"></div>
</div>

<script src="data.js"></script>
<script>
const PAGE_SIZE = 30;
let allData = [], db = null, currentPage = 1, filteredData = [];
const today = new Date().toLocaleDateString("ja-JP");
const PROXIES = ["https://corsproxy.io/?", "https://api.codetabs.com/v1/proxy?quest="];

const req = indexedDB.open("VocaloidGod2025", 6);
req.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("daily")) db.createObjectStore("daily", {keyPath: "date"});
  if (!db.objectStoreNames.contains("hitokoto")) db.createObjectStore("hitokoto", {keyPath: "id", autoIncrement: true});
  if (!db.objectStoreNames.contains("fav")) db.createObjectStore("fav", {keyPath: "sm"});
};
req.onsuccess = e => { db = e.target.result; init(); };

async function init() {
  const cached = await getDaily(today);
  if (cached) {
    allData = cached.data.map((d, i) => ({ ...d, prev: cached.prev?.[i]?.view || d.view }));
    render();
    document.getElementById("last-update").textContent = `今日のデータ（${new Date(cached.time).toLocaleTimeString("ja-JP")}更新）`;
  } else {
    await updateToday();
  }
  loadHitokoto();
  document.getElementById("darkmode").onclick = () => document.body.classList.toggle("dark");
}

async function updateToday() {
  document.getElementById("main").innerHTML = `<div class="loading">今日の最新データを取得中…（1日1回だけ）</div>`;
  const newData = [];
  for (let i = 0; i < HALL_OF_FAME.length; i++) {
    const info = await getInfo(HALL_OF_FAME[i].sm);
    newData.push(info);
    document.querySelector(".loading").innerHTML = `取得中… ${i + 1}/${HALL_OF_FAME.length}<br>${info.title}`;
  }
  const yesterday = getYesterday();
  const prev = await getDaily(yesterday);
  allData = newData.map((d, i) => ({ ...d, prev: prev?.data?.[i]?.view || d.view }));
  await putDaily({ date: today, data: newData, prev: prev?.data, time: Date.now() });
  document.getElementById("last-update").textContent = "最新更新完了！ " + new Date().toLocaleTimeString("ja-JP");
  currentPage = 1;
  render();
}

function getYesterday() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  return d.toLocaleDateString("ja-JP");
}

async function getDaily(date) {
  return new Promise(r => {
    const t = db.transaction("daily");
    t.objectStore("daily").get(date).onsuccess = e => r(e.target.result);
  });
}
async function putDaily(obj) {
  return new Promise(r => {
    const t = db.transaction("daily", "readwrite");
    t.objectStore("daily").put(obj);
    t.oncomplete = r;
  });
}

async function getInfo(sm) {
  for (const p of PROXIES) {
    try {
      const res = await fetch(p + encodeURIComponent("https://ext.nicovideo.jp/api/getthumbinfo/" + sm), { signal: AbortSignal.timeout(12000) });
      if (!res.ok) continue;
      const txt = await res.text();
      if (txt.includes("<error>")) continue;
      const xml = new DOMParser().parseFromString(txt, "text/xml");
      const g = t => xml.querySelector(t)?.textContent.trim() || "";
      const entry = HALL_OF_FAME.find(x => x.sm === sm);
      return {
        sm,
        title: g("title") || "(不明)",
        uploader: g("user_nickname") || g("ch_name") || "不明",
        view: +g("view_counter") || 0,
        date: g("first_retrieve")?.slice(0, 10) || "??",
        tags: entry?.tags || []
      };
    } catch {}
  }
  return { sm, title: "取得失敗", uploader: "-", view: 0, date: "??", tags: [] };
}

function render() {
  document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
  const hash = location.hash.slice(1) || "home";
  document.querySelector(`nav a[href="#${hash}"]`)?.classList.add("active");

  const q = document.getElementById("search").value.toLowerCase();
  filteredData = allData.filter(v =>
    v.title.toLowerCase().includes(q) ||
    v.uploader.toLowerCase().includes(q) ||
    v.tags.some(t => t.toLowerCase().includes(q))
  );

  if (hash === "fav") {
    getAllFav().then(favs => {
      filteredData = filteredData.filter(v => favs.some(f => f.sm === v.sm));
      renderTable();
    });
    return;
  }
  renderTable();
}

async function renderTable() {
  const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
  currentPage = Math.min(currentPage, totalPages || 1);
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageData = filteredData.slice(start, start + PAGE_SIZE);

  let html = `<div style="text-align:center;margin:1rem;color:#555;">全 ${filteredData.length} 曲中 ${start + 1}〜${Math.min(start + PAGE_SIZE, filteredData.length)} 件表示</div>`;

  const hash = location.hash.slice(1) || "home";

  if (hash === "list" || hash === "fav") {
    pageData.forEach(v => {
      const diff = v.view - v.prev;
      const isFav = localStorage.getItem("fav_" + v.sm);
      html += `<div style="background:white;padding:1.5rem;margin:1rem 0;border-radius:12px;box-shadow:0 4px 15px rgba(0,191,255,.2);">
        <span class="fav ${isFav?'on':''}" onclick="toggleFav('${v.sm}')">★</span>
        <strong><a href="https://www.nicovideo.jp/watch/${v.sm}" target="_blank">${v.title}</a></strong><br>
        ${v.uploader} • ${v.date} • ${v.view.toLocaleString()}回
        ${diff !== 0 ? `<span class="diff ${diff > 0 ? 'up' : 'down'}">(${diff > 0 ? '+' + diff : diff})</span>` : ''}
        <div style="margin-top:.5rem;">${v.tags.map(t => `<span class="tag" onclick="document.getElementById('search').value='${t}';currentPage=1;render()">${t}</span>`).join(" ")}</div>
      </div>`;
    });
  } else if (hash === "p") {
    const pcount = {};
    filteredData.forEach(v => pcount[v.uploader] = (pcount[v.uploader] || 0) + 1);
    const ranked = Object.entries(pcount).map(([n, c]) => ({ name: n, cnt: c })).sort((a, b) => b.cnt - a.cnt);
    html += "<table><thead><tr><th>#</th><th>P名</th><th>殿堂入り数</th></tr></thead><tbody>";
    ranked.forEach((v, i) => html += `<tr><td>${i + 1}</td><td>${v.name}</td><td>${v.cnt}曲</td></tr>`);
    html += "</tbody></table>";
  } else {
    html += "<table><thead><tr><th>#</th><th>曲名</th><th>投稿者</th><th>再生数</th></tr></thead><tbody>";
    filteredData.sort((a, b) => b.view - a.view);
    pageData.forEach((v, i) => {
      const rank = start + i + 1;
      const diff = v.view - v.prev;
      const isFav = localStorage.getItem("fav_" + v.sm);
      html += `<tr>
        <td style="text-align:center;font-weight:bold;color:#00bfff;">${rank}位</td>
        <td><span class="fav ${isFav?'on':''}" onclick="toggleFav('${v.sm}')">★</span>
        <a href="https://www.nicovideo.jp/watch/${v.sm}" target="_blank">${v.title}</a>
        ${diff !== 0 ? ` <span class="diff ${diff > 0 ? 'up' : 'down'}">(${diff > 0 ? '+' + diff : diff})</span>` : ""}</td>
        <td>${v.uploader}</td>
        <td style="text-align:right;">${v.view.toLocaleString()}回</td>
      </tr>`;
    });
    html += "</tbody></table>";
  }

  document.getElementById("main").innerHTML = html;
  renderPagination(totalPages);
  document.getElementById("hitokoto-section").style.display = hash === "hitokoto" ? "block" : "none";
  if (hash === "hitokoto") loadHitokoto();
}

function renderPagination(total) {
  if (total <= 1) { document.getElementById("pagination").innerHTML = ""; return; }
  let html = "";
  if (currentPage > 1) html += `<button onclick="currentPage--;render()">‹ 前へ</button>`;
  for (let i = 1; i <= total; i++) {
    if (i === 1 || i === total || (i >= currentPage - 2 && i <= currentPage + 2))
      html += `<button class="${i === currentPage ? 'active' : ''}" onclick="currentPage=${i};render()">${i}</button>`;
    else if (i === currentPage - 3 || i === currentPage + 3) html += `<span>...</span>`;
  }
  if (currentPage < total) html += `<button onclick="currentPage++;render()">次へ ›</button>`;
  document.getElementById("pagination").innerHTML = html;
}

function toggleFav(sm) {
  if (localStorage.getItem("fav_" + sm)) localStorage.removeItem("fav_" + sm);
  else localStorage.setItem("fav_" + sm, "1");
  render();
}

async function getAllFav() {
  const favs = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith("fav_")) favs.push({ sm: key.slice(4) });
  }
  return favs;
}

function loadHitokoto() {
  const tx = db.transaction("hitokoto");
  tx.objectStore("hitokoto").getAll().onsuccess = e => {
    const posts = e.target.result.reverse();
    document.getElementById("hitokoto-list").innerHTML = posts.length ? posts.map((p, i) => `
      <div class="hitokoto-item">
        <span class="hitokoto-no">${i + 1}</span>
        <span class="hitokoto-name">${p.name || "名無し"}</span>
        <span class="hitokoto-comment">${p.comment}</span>
        <span class="hitokoto-date">${p.date}</span>
      </div>`).join("") : "<p style='text-align:center;color:#999;padding:3rem;'>まだ書き込みがありません！最初の一言をどうぞ！</p>";
  };
}

document.getElementById("hitokoto-submit").onclick = () => {
  const name = document.getElementById("hitokoto-name").value.trim() || "名無し";
  const comment = document.getElementById("hitokoto-comment").value.trim();
  if (!comment) return alert("一言を書いてね！");
  const tx = db.transaction("hitokoto", "readwrite");
  tx.objectStore("hitokoto").add({ name, comment, date: new Date().toLocaleString("ja-JP") });
  tx.oncomplete = () => {
    document.getElementById("hitokoto-comment").value = "";
    loadHitokoto();
  };
};

document.getElementById("update").onclick = updateToday;
document.getElementById("search").oninput = () => { currentPage = 1; render(); };
window.onhashchange = () => { currentPage = 1; render(); };
</script>
</body>
</html>
