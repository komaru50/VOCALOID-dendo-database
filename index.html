<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ボカロ殿堂入りデータベース</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
body {font-family:'Noto Sans JP',sans-serif;background:#f5fbff;color:#222;margin:0;padding:0;}
body.dark {background:#121212;color:#eee;}
header {background:linear-gradient(135deg,#00bfff,#0088cc);color:white;padding:2rem;text-align:center;position:relative;}
h1 {margin:0;font-size:2.5rem;text-shadow:0 2px 10px rgba(0,0,0,.3);}
nav {background:#008fd5;padding:1rem;text-align:center;}
nav a {color:white;margin:0 .8rem;padding:.7rem 1.4rem;border-radius:50px;text-decoration:none;font-weight:bold;transition:.3s;}
nav a:hover, nav a.active {background:#0066aa;transform:scale(1.05);}
.container {max-width:1400px;margin:2rem auto;padding:0 1rem;}
.search-box {text-align:center;margin:2rem 0;}
.search-box input {padding:1rem 2rem;font-size:1.2rem;width:600px;max-width:90%;border-radius:50px;border:3px solid #00bfff;outline:none;transition:.3s;}
.search-box input:focus {border-color:#0066aa;box-shadow:0 0 20px rgba(0,191,255,.5);}
table {width:100%;border-collapse:collapse;background:white;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,191,255,.2);margin-bottom:2rem;}
body.dark table {background:#1e1e1e;box-shadow:0 10px 30px rgba(0,0,0,.5);}
th {background:#00bfff;color:white;padding:1.3rem;font-size:1.1rem;}
td {padding:1rem;border-bottom:1px solid #ddd;text-align:left;}
tr:hover {background:#e6f7ff;}
body.dark tr:hover {background:#2a2a2a;}
a {color:#00bfff;text-decoration:none;font-weight:600;}
a:hover {text-decoration:underline;}
.tag {display:inline-block;background:#00bfff;color:white;padding:.4rem .9rem;border-radius:30px;margin:0.3rem;font-size:0.9rem;}
.tag.deleted {background:#ff4444;}
.fav {cursor:pointer;font-size:1.5rem;margin-right:.6rem;transition:.3s;}
.fav.on {color:#ff4444;transform:scale(1.2);}
.loading {text-align:center;padding:5rem;font-size:1.6rem;color:#0066aa;}
.pagination {text-align:center;margin:3rem 0;}
.pagination button {padding:.8rem 1.4rem;margin:0 .3rem;border:none;border-radius:50px;background:#00bfff;color:white;cursor:pointer;font-weight:bold;transition:.3s;}
.pagination button:hover {background:#0066aa;transform:scale(1.05);}
.pagination button.active {background:#0066aa;}
#darkmode {position:absolute;top:20px;left:20px;background:rgba(0,0,0,.5);color:white;padding:.8rem 1.3rem;border-radius:50%;cursor:pointer;font-weight:bold;}
.update-btn {position:absolute;top:20px;right:20px;background:#ff4444;color:white;border:none;padding:.8rem 1.6rem;border-radius:50px;cursor:pointer;font-weight:bold;}
.last-update {position:absolute;top:70px;right:20px;color:rgba(255,255,255,.9);font-size:0.9rem;background:rgba(0,0,0,.3);padding:.4rem .8rem;border-radius:8px;}
#hitokoto-section {background:white;border-radius:15px;padding:3rem;margin:3rem auto;max-width:1000px;box-shadow:0 10px 30px rgba(0,191,255,.2);}
body.dark #hitokoto-section {background:#1e1e1e;}
.hitokoto-item {padding:1.2rem 0;border-bottom:1px dashed #bde0fe;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
.hitokoto-no {color:#00bfff;font-weight:bold;width:50px;text-align:center;font-size:1.2rem;}
.hitokoto-name {color:#00bfff;font-weight:bold;}
.hitokoto-comment {flex:1;font-size:1.1rem;}
.hitokoto-date {color:#888;font-size:0.9rem;}
</style>
</head>
<body>

<header>
  <h1>ボカロ殿堂入りデータベース</h1>
  <button class="update-btn" id="update">今日のデータを更新</button>
  <div class="last-update" id="last-update">読み込み中…</div>
  <div id="darkmode" title="ダークモード切替">Night</div>
</header>

<nav>
  <a href="#home" class="active">ランキング</a>
  <a href="#list">全曲一覧</a>
  <a href="#uploader">P別ランキング</a>
  <a href="#fav">お気に入り</a>
  <a href="#deleted">転載・削除曲</a>
  <a href="#hitokoto">一言掲示板</a>
</nav>

<div class="search-box">
  <input type="text" id="search" placeholder="曲名・投稿者・タグで検索">
</div>

<div class="container" id="main">
  <div class="loading">データ読み込み中…</div>
</div>

<div class="pagination" id="pagination"></div>

<div id="hitokoto-section" style="display:none;">
  <h2 style="text-align:center;color:#00bfff;margin-bottom:2rem;">一言掲示板</h2>
  <div style="background:#f0fbff;padding:2rem;border-radius:15px;text-align:center;margin-bottom:2rem;">
    <input type="text" id="hitokoto-name" placeholder="名前（省略可）" maxlength="20" style="padding:.9rem;border-radius:50px;border:2px solid #00bfff;margin:0 .5rem;width:220px;">
    <input type="text" id="hitokoto-comment" placeholder="一言どうぞ（100文字まで）" maxlength="100" style="padding:.9rem;border-radius:50px;border:2px solid #00bfff;margin:0 .5rem;width:400px;">
    <button id="hitokoto-submit" style="padding:.9rem 2.2rem;background:#00bfff;color:white;border:none;border-radius:50px;font-weight:bold;">書き込む</button>
  </div>
  <div id="hitokoto-list"></div>
</div>

<script>
// ========== 設定 ==========
const SPREADSHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbz1youYaIV3-B9v3SzUA_K_opQ-6tHOAxfOU9KZuC0ulgWQaZKrVzEaHXR6vnhoiB4s/exec";  // ← ここに自分のURLを入れる！
const DELETED_JSON_URL = SPREADSHEET_JSON_URL + "?type=deleted";
const PAGE_SIZE = 50;
let allData = [], deletedData = [], db = null, currentPage = 1;

// ========== IndexedDB ==========
const req = indexedDB.open("VocaloidDB", 9);
req.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("daily")) db.createObjectStore("daily", {keyPath: "date"});
  if (!db.objectStoreNames.contains("hitokoto")) db.createObjectStore("hitokoto", {keyPath: "id", autoIncrement: true});
  if (!db.objectStoreNames.contains("fav")) db.createObjectStore("fav", {keyPath: "sm"});
};
req.onsuccess = e => { db = e.target.result; init(); };

// ========== データ読み込み ==========
async function init() {
  document.getElementById("darkmode").onclick = () => document.body.classList.toggle("dark");
  document.getElementById("update").onclick = loadData;
  document.getElementById("search").oninput = () => { currentPage = 1; render(); };
  window.onhashchange = () => { currentPage = 1; render(); };

  const today = new Date().toLocaleDateString("ja-JP");
  const cached = await getDaily(today);
  if (cached) {
    allData = cached.data;
    document.getElementById("last-update").textContent = `最終更新：${new Date(cached.time).toLocaleString("ja-JP")}`;
  }
  await loadDeletedData();
  render();
  loadHitokoto();
}

async function loadData() {
  document.getElementById("main").innerHTML = "<div class='loading'>再生数取得中…（数秒かかります）</div>";
  try {
    const res = await fetch(SPREADSHEET_JSON_URL + "?t=" + Date.now());
    allData = await res.json();

    const today = new Date().toLocaleDateString("ja-JP");
    await putDaily({ date: today, data: allData, time: Date.now() });
    document.getElementById("last-update").textContent = `最終更新：${new Date().toLocaleString("ja-JP")}（手動更新）`;
    render();
  } catch (e) {
    document.getElementById("main").innerHTML = "<div class='loading' style='color:#c33;'>読み込み失敗…リロードしてください</div>";
  }
}

async function loadDeletedData() {
  try {
    const res = await fetch(DELETED_JSON_URL + "&t=" + Date.now());
    deletedData = await res.json();
  } catch (e) {
    console.error("削除曲データ読み込み失敗", e);
    deletedData = [];
  }
}

// ========== IndexedDBヘルパー ==========
async function getDaily(date) { return new Promise(r => db.transaction("daily").objectStore("daily").get(date).onsuccess = e => r(e.target.result)); }
async function putDaily(obj) { return new Promise(r => db.transaction("daily","readwrite").objectStore("daily").put(obj).onsuccess = r); }

// ========== お気に入り ==========
function toggleFav(sm) {
  const key = "fav_" + sm;
  if (localStorage.getItem(key)) localStorage.removeItem(key);
  else localStorage.setItem(key, "1");
  render();
}

// ========== 一言掲示板 ==========
function loadHitokoto() {
  const tx = db.transaction("hitokoto");
  tx.objectStore("hitokoto").getAll().onsuccess = e => {
    const posts = e.target.result.reverse();
    document.getElementById("hitokoto-list").innerHTML = posts.length ? posts.map((p, i) => `
      <div class="hitokoto-item">
        <span class="hitokoto-no">${posts.length - i}</span>
        <span class="hitokoto-name">${p.name || "名無し"}</span>
        <span class="hitokoto-comment">${p.comment}</span>
        <span class="hitokoto-date">${p.date}</span>
      </div>`).join("") : "<p style='text-align:center;color:#999;padding:4rem;'>まだ書き込みがありません</p>";
  };
}
document.getElementById("hitokoto-submit").onclick = () => {
  const name = document.getElementById("hitokoto-name").value.trim() || "名無し";
  const comment = document.getElementById("hitokoto-comment").value.trim();
  if (!comment) return;
  db.transaction("hitokoto","readwrite").objectStore("hitokoto").add({
    name, comment, date: new Date().toLocaleString("ja-JP")
  }).onsuccess = () => {
    document.getElementById("hitokoto-comment").value = "";
    loadHitokoto();
  };
};

// ========== メイン描画 ==========
function render() {
  const hash = location.hash.slice(1) || "home";
  document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
  document.querySelector(`nav a[href="#${hash}"]`)?.classList.add("active");

  let filtered = [...allData];
  const q = document.getElementById("search").value.trim().toLowerCase();
  if (q) {
    filtered = filtered.filter(v => 
      v.title.toLowerCase().includes(q) || 
      v.uploader.toLowerCase().includes(q) || 
      v.tags.some(t => t.toLowerCase().includes(q))
    );
  }

  if (hash === "fav") {
    const favs = Object.keys(localStorage).filter(k => k.startsWith("fav_")).map(k => k.slice(4));
    filtered = filtered.filter(v => favs.includes(v.sm));
  }

  if (hash === "hitokoto") {
    document.getElementById("main").innerHTML = "";
    document.getElementById("pagination").innerHTML = "";
    document.getElementById("hitokoto-section").style.display = "block";
    return;
  } else {
    document.getElementById("hitokoto-section").style.display = "none";
  }

  // ========== 転載・削除曲ページ ==========
  if (hash === "deleted") {
    document.title = "転載・削除曲 - ボカロ殿堂入りデータベース";
    let html = `<h2 style="text-align:center;color:#ff4444;margin:2rem 0;font-size:2rem;">転載・削除された楽曲（全 ${deletedData.length} 曲）</h2>`;
    if (deletedData.length === 0) {
      html += "<p style='text-align:center;color:#999;padding:4rem;font-size:1.4rem;'>まだ登録されていません</p>";
    } else {
      html += `<table><thead><tr>
        <th width="5%">#</th>
        <th width="35%">曲名</th>
        <th width="15%">投稿者</th>
        <th width="15%">最終再生数</th>
        <th width="15%">削除日</th>
        <th width="15%">タグ</th>
      </tr></thead><tbody>`;
      deletedData.forEach((v, i) => {
        html += `<tr>
          <td style="text-align:center;font-weight:bold;color:#ff6666;">${i+1}</td>
          <td><a href="${v.url}" target="_blank" style="color:#ff4444;font-weight:bold;font-size:1.1rem;">${v.title}</a></td>
          <td>${v.uploader}</td>
          <td style="text-align:right;font-weight:bold;color:#ff6666;">${v.lastView.toLocaleString()} 回</td>
          <td style="text-align:center;">${v.deleteDate}</td>
          <td>${v.tags.map(t => `<span class="tag deleted">${t}</span>`).join(" ")}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
    }
    document.getElementById("main").innerHTML = html;
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  // ========== 通常ページ（ランキング・一覧など）==========
  document.title = "ボカロ殿堂入りデータベース";
  let html = "";

  if (hash === "home" || hash === "") {
    filtered.sort((a,b) => b.view - a.view);
    html += `<table><thead><tr><th>#</th><th>曲名</th><th>投稿者</th><th>再生数</th><th>投稿日</th></tr></thead><tbody>`;
    filtered.slice(0, 100).forEach((v, i) => {
      const isFav = localStorage.getItem("fav_" + v.sm);
      html += `<tr>
        <td style="text-align:center;font-weight:bold;color:#00bfff;font-size:1.3rem;">${i+1}</td>
        <td><span class="fav ${isFav?'on':''}" onclick="toggleFav('${v.sm}')">★</span>
            <a href="https://www.nicovideo.jp/watch/${v.sm}" target="_blank">${v.title}</a></td>
        <td>${v.uploader}</td>
        <td style="text-align:right;font-weight:bold;">${v.view.toLocaleString()} 回</td>
        <td style="text-align:center;">${v.date}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }

  // 一覧・P別・お気に入りは必要に応じて追加（省略）

  document.getElementById("main").innerHTML = html;
  document.getElementById("pagination").innerHTML = "";
}

render(); // 初回描画
</script>
</body>
</html>
