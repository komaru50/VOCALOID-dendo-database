<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ボカロ殿堂入りデータベース</title>
<style>
/* 前と同じCSSを全部貼る（省略しないでそのまま使ってください） */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
body{font-family:'Noto Sans JP',sans-serif;background:#f5fbff;color:#222;margin:0;}
body.dark{background:#121212;color:#eee;}
header{background:#00bfff;color:white;padding:2rem;text-align:center;position:relative;}
h1{margin:0;font-size:2.3rem;}
nav{background:#008fd5;padding:1rem;text-align:center;}
nav a{color:white;margin:0 1rem;padding:.6rem 1.2rem;border-radius:8px;text-decoration:none;font-weight:bold;}
nav a.active,nav a:hover{background:#0066aa;}
.container{max-width:1300px;margin:2rem auto;padding:0 1rem;}
.search-box{text-align:center;margin:2rem 0;}
.search-box input{padding:1rem 1.5rem;font-size:1.2rem;width:500px;max-width:90%;border-radius:50px;border:3px solid #00bfff;outline:none;}
table{width:100%;border-collapse:collapse;background:white;border-radius:15px;overflow:hidden;box-shadow:0 8px 30px rgba(0,191,255,.2);margin-bottom:2rem;}
body.dark table{background:#1e1e1e;}
th{background:#00bfff;color:white;padding:1.2rem;}
td{padding:1rem;border-bottom:1px solid #ddd;}
tr:hover{background:#f0fbff;}
body.dark tr:hover{background:#2a2a2a;}
a{color:#00bfff;text-decoration:none;font-weight:600;}
.tag{display:inline-block;background:#00bfff;color:white;padding:.3rem .8rem;border-radius:30px;margin:0.2rem;font-size:0.85rem;}
.update-btn{position:absolute;top:20px;right:20px;background:#ff4444;color:white;border:none;padding:.8rem 1.5rem;border-radius:50px;cursor:pointer;}
.last-update{position:absolute;top:70px;right:20px;color:rgba(255,255,255,.9);font-size:0.9rem;}
#darkmode{position:absolute;top:20px;left:20px;background:#333;color:white;padding:.8rem 1.2rem;border-radius:50%;cursor:pointer;}
.fav{cursor:pointer;font-size:1.4rem;margin-right:.5rem;}
.fav.on{color:#ff4444;}
.loading{text-align:center;padding:4rem;font-size:1.4rem;color:#0066aa;}
.pagination{text-align:center;margin:2rem 0;}
.pagination button{padding:.7rem 1.3rem;margin:0 .2rem;border:none;border-radius:8px;background:#00bfff;color:white;cursor:pointer;}
.pagination button.active{background:#0066aa;}
#hitokoto-section{background:white;border-radius:15px;padding:3rem;margin:3rem auto;max-width:900px;box-shadow:0 10px 30px rgba(0,191,255,.2);display:none;}
body.dark #hitokoto-section{background:#1e1e1e;}
.hitokoto-item{padding:1rem 0;border-bottom:1px dashed #bde0fe;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
.hitokoto-no{color:#00bfff;font-weight:bold;width:40px;text-align:center;}
.hitokoto-name{color:#00bfff;font-weight:bold;}
.hitokoto-comment{flex:1;}
.hitokoto-date{color:#888;font-size:0.9rem;}
</style>
</head>
<body>

<header>
  <h1>ボカロ殿堂入りデータベース</h1>
  <div class="last-update" id="last-update">読み込み中…</div>
  <div id="darkmode" title="ダークモード">Night</div>
</header>

<nav>
  <a href="#home" class="active">ランキング</a>
  <a href="#list">全曲一覧</a>
  <a href="#fav">お気に入り</a>
  <a href="#hitokoto">掲示板</a>
</nav>

<div class="search-box">
  <input type="text" id="search" placeholder="曲名・投稿者・タグで検索">
</div>

<div class="container" id="main"></div>
<div class="pagination" id="pagination"></div>

<div id="hitokoto-section">
  <h2 style="text-align:center;color:#00bfff;margin-bottom:2rem;">一言掲示板</h2>
  <div style="background:#f0fbff;padding:2rem;border-radius:12px;text-align:center;margin-bottom:2rem;">
    <input type="text" id="hitokoto-name" placeholder="名前（省略可）" maxlength="20" style="padding:.8rem;border-radius:50px;border:2px solid #00bfff;margin:0 .5rem;width:200px;">
    <input type="text" id="hitokoto-comment" placeholder="一言どうぞ" maxlength="100" style="padding:.8rem;border-radius:50px;border:2px solid #00bfff;margin:0 .5rem;width:320px;">
    <button id="hitokoto-submit" style="padding:.8rem 2rem;background:#00bfff;color:white;border:none;border-radius:50px;">書き込む</button>
  </div>
  <div id="hitokoto-list"></div>
</div>

<script>
// ←←←←←←←←←← ここだけ自分のURLに書き換え！！！ ←←←←←←←←←←
const SPREADSHEET_JSON_URL = "https://docs.google.com/spreadsheets/d/1iCMZoX9MZAA95ZDbU9wB3hAawdCOx0UeitO9gPyEEqQ/edit?usp=sharing/exec";
// ←←←←←←←←←← ここまで！！！ ←←←←←←←←←←

const PAGE_SIZE = 30;
let allData = [], db = null, currentPage = 1;

async function loadData() {
  document.getElementById("main").innerHTML = "<div class='loading'>データ読み込み中…</div>";
  try {
    const res = await fetch(SPREADSHEET_JSON_URL + "?t=" + Date.now()); // キャッシュ回避
    allData = await res.json();
    document.getElementById("last-update").textContent = `最終更新：${new Date().toLocaleString("ja-JP")}`;
    render();
  } catch(e) {
    document.getElementById("main").innerHTML = "<div class='loading' style='color:#c33;'>読み込み失敗…ページをリロードしてください</div>";
  }
}

// 以下は前と同じrender関数・お気に入り・掲示板・ページネーション全部そのまま
const req = indexedDB.open("VocaloidDB", 10);
req.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains("hitokoto")) db.createObjectStore("hitokoto", {keyPath: "id", autoIncrement: true});
};
req.onsuccess = e => { db = e.target.result; loadData(); loadHitokoto(); };

document.getElementById("darkmode").onclick = () => document.body.classList.toggle("dark");

function render() {
  document.querySelectorAll("nav a").forEach(a => a.classList.remove("active"));
  const hash = location.hash.slice(1) || "home";
  document.querySelector(`nav a[href="#${hash}"]`)?.classList.add("active");

  let filtered = allData.filter(v => {
    const q = (document.getElementById("search").value||"").toLowerCase();
    return !q || 
      v.title.toLowerCase().includes(q) || 
      v.uploader.toLowerCase().includes(q) ||
      (v.tags && v.tags.some(t => t.toLowerCase().includes(q)));
  });

  if (hash === "fav") {
    const favs = Object.keys(localStorage).filter(k => k.startsWith("fav_")).map(k => k.slice(4));
    filtered = filtered.filter(v => favs.includes(v.sm));
  }

  if (hash === "hitokoto") {
    document.getElementById("main").innerHTML = ""; 
    document.getElementById("pagination").innerHTML = "";
    document.getElementById("hitokoto-section").style.display = "block"; 
    return;
  } else {
    document.getElementById("hitokoto-section").style.display = "none";
  }

  if (hash === "home") filtered.sort((a,b) => b.view - a.view);

  const total = filtered.length;
  const pages = Math.ceil(total / PAGE_SIZE);
  currentPage = Math.min(currentPage, pages || 1);
  const start = (currentPage-1) * PAGE_SIZE;
  const pageData = filtered.slice(start, start + PAGE_SIZE);

  let html = `<div style="text-align:center;margin:1rem;color:#555;">全 ${total} 曲中 ${start+1}〜${Math.min(start+PAGE_SIZE, total)} 件</div>`;
  html += `<table><thead><tr><th>#</th><th>曲名</th><th>投稿者</th><th>再生数</th><th>タグ</th></tr></thead><tbody>`;
  pageData.forEach((v, i) => {
    const rank = hash === "home" ? filtered.indexOf(v) + 1 : start + i + 1;
    const isFav = localStorage.getItem("fav_"+v.sm);
    html += `<tr>
      <td style="text-align:center;font-weight:bold;color:#00bfff;">${rank}</td>
      <td><span class="fav ${isFav?'on':''}" onclick="toggleFav('${v.sm}')">★</span>
          <a href="https://www.nicovideo.jp/watch/${v.sm}" target="_blank">${v.title}</a></td>
      <td>${v.uploader}</td>
      <td style="text-align:right;">${Number(v.view).toLocaleString()}</td>
      <td>${(v.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</td>
    </tr>`;
  });
  html += `</tbody></table>`;

  // ページネーション
  let pagi = "";
  for (let i=1; i<=pages; i++) {
    pagi += `<button ${i===currentPage?"class='active'":""} onclick="currentPage=${i};render()">${i}</button>`;
  }
  document.getElementById("pagination").innerHTML = pagi;

  document.getElementById("main").innerHTML = html;
}

function toggleFav(sm) {
  const key = "fav_" + sm;
  if (localStorage.getItem(key)) localStorage.removeItem(key);
  else localStorage.setItem(key, "1");
  render();
}

function loadHitokoto() {
  const tx = db.transaction("hitokoto");
  tx.objectStore("hitokoto").getAll().onsuccess = e => {
    const posts = e.target.result.reverse();
    document.getElementById("hitokoto-list").innerHTML = posts.length ? posts.map((p,i) => `
      <div class="hitokoto-item">
        <span class="hitokoto-no">${i+1}</span>
        <span class="hitokoto-name">${p.name||"名無しさん"}</span>
        <span class="hitokoto-comment">${p.comment}</span>
        <span class="hitokoto-date">${p.date}</span>
      </div>`).join("") : "<p style='text-align:center;color:#999;padding:3rem;'>まだ書き込みがありません</p>";
  };
}

document.getElementById("hitokoto-submit").onclick = () => {
  const name = document.getElementById("hitokoto-name").value.trim() || "名無しさん";
  const comment = document.getElementById("hitokoto-comment").value.trim();
  if (!comment) return;
  db.transaction("hitokoto","readwrite").objectStore("hitokoto").add({
    name, comment, date: new Date().toLocaleString("ja-JP")
  }).onsuccess = () => {
    document.getElementById("hitokoto-comment").value = "";
    loadHitokoto();
  };
};

document.getElementById("search").oninput = () => { currentPage=1; render(); };
window.onhashchange = () => { currentPage=1; render(); };
</script>
</body>
</html>
